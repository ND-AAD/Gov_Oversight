name: ðŸš€ Deploy Surveillance Dashboard

on:
  # Deploy when new surveillance data is committed
  push:
    branches: [ main ]
    paths:
      - 'data/**'
      - 'frontend/**'
      - '.github/workflows/deploy.yml'
  
  # Allow manual deployment
  workflow_dispatch:

  # Deploy after successful scraping
  workflow_run:
    workflows: ["ðŸ•µï¸ RFP Surveillance Monitor"]
    types:
      - completed

# Required for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Prevent concurrent deployments
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-surveillance-dashboard:
    name: ðŸ—ï¸ Build Public Surveillance Dashboard
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout surveillance monitoring code
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js for frontend build
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: ðŸ“¦ Install frontend dependencies
        run: |
          cd frontend
          npm ci
      
      - name: ðŸ“Š Prepare surveillance data for static hosting
        run: |
          echo "ðŸ”„ Preparing surveillance contract data..."
          
          # Ensure public data directory exists
          mkdir -p frontend/public/data
          
          # Copy latest RFP data to public directory for static access
          if [ -f "data/rfps.json" ]; then
            cp data/rfps.json frontend/public/data/
            echo "âœ… RFP data copied to public directory"
          else
            echo "âš ï¸ No RFP data found - using sample data"
            cp data/sample_rfps.json frontend/public/data/rfps.json 2>/dev/null || echo "{\"rfps\": []}" > frontend/public/data/rfps.json
          fi
          
          # Copy site configurations
          if [ -f "data/sites.json" ]; then
            cp data/sites.json frontend/public/data/
            echo "âœ… Site data copied to public directory"
          else
            echo "âš ï¸ No site data found - using sample data"
            cp data/sample_sites.json frontend/public/data/sites.json 2>/dev/null || echo "{\"sites\": []}" > frontend/public/data/sites.json
          fi
          
          # Generate metadata for the dashboard
          cat > frontend/public/data/metadata.json << EOF
          {
            "last_updated": "$(date -u -Iseconds)",
            "deployment_id": "${{ github.run_number }}",
            "commit_sha": "${{ github.sha }}",
            "workflow_run": "${{ github.run_id }}",
            "repository": "${{ github.repository }}",
            "monitoring_mission": "2028 Olympics Surveillance Contract Transparency",
            "data_sources": "LA City, CA State, Metro LA procurement portals",
            "update_frequency": "Every 6 hours via automated scraping",
            "alert_keywords": ["surveillance", "security", "biometric", "facial recognition", "monitoring", "intelligence", "camera", "tracking"]
          }
          EOF
          
          echo "ðŸ“‹ Generated dashboard metadata"
      
      - name: ðŸ—ï¸ Build surveillance dashboard for production
        run: |
          cd frontend
          
          echo "ðŸ—ï¸ Building public surveillance transparency dashboard..."
          
          # Set production environment variables
          export VITE_API_MODE=static
          export VITE_APP_TITLE="LA 2028 RFP Surveillance Monitor"
          export VITE_APP_DESCRIPTION="Public oversight of 2028 Olympics surveillance contracts"
          export VITE_REPO_URL="${{ github.server_url }}/${{ github.repository }}"
          export VITE_DEPLOYMENT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          
          # Build the React app for static hosting
          npm run build
          
          echo "âœ… Dashboard built successfully"
          echo "ðŸ“Š Build size:"
          du -sh dist/
      
      - name: ðŸ”§ Configure GitHub Pages deployment
        uses: actions/configure-pages@v4
      
      - name: ðŸ“¤ Upload surveillance dashboard artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: frontend/dist
          name: surveillance-dashboard
      
      - name: ðŸ“Š Generate deployment summary
        run: |
          echo "## ðŸš€ Surveillance Dashboard Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸŽ¯ Mission:** Public transparency for 2028 Olympics surveillance contracts" >> $GITHUB_STEP_SUMMARY
          echo "**â° Deployed:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ”„ Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“ Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Data Status" >> $GITHUB_STEP_SUMMARY
          
          # Check data files and report status
          if [ -f "frontend/public/data/rfps.json" ]; then
            RFP_COUNT=$(python3 -c "import json; print(len(json.load(open('frontend/public/data/rfps.json'))['rfps']))" 2>/dev/null || echo "unknown")
            echo "- **ðŸ“‹ RFPs Monitored:** $RFP_COUNT surveillance contracts" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "frontend/public/data/sites.json" ]; then
            SITE_COUNT=$(python3 -c "import json; print(len(json.load(open('frontend/public/data/sites.json'))['sites']))" 2>/dev/null || echo "unknown")
            echo "- **ðŸ›ï¸ Government Sites:** $SITE_COUNT procurement portals" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- **ðŸ”„ Update Frequency:** Every 6 hours (automated)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Access Links" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸŒ Public Dashboard:** Will be available after deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ“Š Raw Data:** [\`rfps.json\`](https://github.com/${{ github.repository }}/blob/main/data/rfps.json)" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ›ï¸ Site Configs:** [\`sites.json\`](https://github.com/${{ github.repository }}/blob/main/data/sites.json)" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ” Source Code:** [GitHub Repository](https://github.com/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY

  deploy-to-github-pages:
    name: ðŸŒ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-surveillance-dashboard
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ðŸš€ Deploy surveillance dashboard to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact_name: surveillance-dashboard
      
      - name: ðŸ“¢ Announce deployment
        run: |
          echo "ðŸŽ‰ SURVEILLANCE DASHBOARD DEPLOYED!"
          echo "ðŸŒ Public URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ðŸ•µï¸ Mission: 2028 Olympics surveillance contract transparency"
          echo "ðŸ“Š Real-time monitoring of government procurement"
          echo ""
          echo "ðŸ”— Dashboard: ${{ steps.deployment.outputs.page_url }}"
          echo "ðŸ“Š Data API: ${{ steps.deployment.outputs.page_url }}data/rfps.json"
          echo "ðŸ›ï¸ Site Configs: ${{ steps.deployment.outputs.page_url }}data/sites.json"
          
          # Add to job summary
          echo "## ðŸŽ‰ Surveillance Dashboard Successfully Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸŒ Public URL:** [${{ steps.deployment.outputs.page_url }}](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The public can now access real-time surveillance contract monitoring for the 2028 Olympics." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Quick Access" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸŽ¯ Dashboard:** [${{ steps.deployment.outputs.page_url }}](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ“Š RFP Data API:** [${{ steps.deployment.outputs.page_url }}data/rfps.json](${{ steps.deployment.outputs.page_url }}data/rfps.json)" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ›ï¸ Sites API:** [${{ steps.deployment.outputs.page_url }}data/sites.json](${{ steps.deployment.outputs.page_url }}data/sites.json)" >> $GITHUB_STEP_SUMMARY
